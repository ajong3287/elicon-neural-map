# STEP05.2 완결 작업 로그

**날짜**: 2025-12-23
**작업자**: 클로드 (Claude Code)
**작업 범위**: STEP05.2 edge quality upgrade (import-based dependencies)

---

## 작업 요약

### 완료된 PR

| PR | 제목 | 파일 수 | 상태 | URL |
|---|------|--------|------|-----|
| #13 | STEP05.2 — edge quality (import-based) | 2 | OPEN | https://github.com/ajong3287/elicon-neural-map/pull/13 |

---

## PR #13 (STEP05.2)

### 목적
- 폴더 기반 스타 토폴로지 → import/require 기반 의존성 엣지로 업그레이드
- 노드 ID 안정화 (`f1` → `p:src/app/map/page.tsx`)

### 변경 파일
```
1. scripts/scan_repo.mjs    - import/require 추출 로직 추가
2. public/graph.json         - 안정화된 노드 ID + 의존성 엣지 (84 nodes, 3 edges)
```

### 커밋
```
a4a699c2 feat: step05.2 edge quality upgrade (NEURALMAP-STEP05.2-v0.1)
```

### 주요 변경사항

#### 1. 노드 ID 안정화
**이전**: 순차적 ID (`f1`, `f2`, `f3`, ...)
- 문제: 파일 추가/삭제 시 ID 변경

**이후**: 경로 기반 ID (`p:src/app/map/page.tsx`)
- 장점: 파일 순서 변경 시에도 ID 안정성 유지

#### 2. 엣지 로직 업그레이드
**이전**: 폴더 기반 스타 토폴로지
```javascript
// 모든 파일 → 부모 폴더
for folder in folders:
  for file in folder:
    edge: file -> folder (*)
```

**이후**: import/require 기반 의존성
```javascript
// 실제 코드 의존성 추적
extractImports(file)  // regex로 import/require 추출
resolveImport(file, imp)  // 상대 경로 해결 + 확장자 fallback
```

#### 3. Regex 패턴
```javascript
// 3가지 import 패턴 지원
const importRegex = /import\s+.*?from\s+['"]([^'"]+)['"]/g;        // import ... from "..."
const dynamicImportRegex = /import\s*\(\s*['"]([^'"]+)['"]\s*\)/g; // import("...")
const requireRegex = /require\s*\(\s*['"]([^'"]+)['"]\s*\)/g;     // require("...")
```

#### 4. 경로 해결 (Path Resolution)
```javascript
// 확장자 fallback (.ts, .tsx, .js, .jsx, .mjs, /index.*)
const extensions = ['', '.ts', '.tsx', '.js', '.jsx', '.mjs',
                   '/index.ts', '/index.tsx', '/index.js', '/index.jsx'];

// 예시:
// "./MapClient" -> "src/app/map/MapClient.tsx"
```

### 생성된 엣지 (3개)

```
1. src/app/map/page.tsx -> src/app/map/MapClient.tsx
2. src/app/ops/page.tsx -> src/app/ops/OpsActions.tsx
3. tools/build-graph.mjs -> tools/lib/graph-metrics.mjs
```

### 디버깅 과정

#### 이슈: 초기 실행 시 0개 엣지
**원인**: stash된 파일들이 복원되지 않은 상태에서 스캔 실행

**해결**:
1. `git stash pop` 실행 → 파일 복원
2. 디버그 로그 추가 → import 추출 과정 확인
3. 3개 엣지 정상 생성 확인
4. 디버그 로그 제거 → 클린 버전

#### 검증 로그
```bash
# 디버그 실행
[DEBUG] src/app/map/page.tsx: found 2 imports: [ 'react', './MapClient' ]
[DEBUG]   ./MapClient -> src/app/map/MapClient.tsx (in fileSet: true)

# 최종 결과
SCAN_OK
files: 84
nodes: 84
edges: 3
```

---

## 검증 완료 사항

- [x] pnpm build: Exit 0
- [x] 파일 수: 2개 (scan_repo.mjs + graph.json)
- [x] 엣지 수: 3개 (0→3 해결)
- [x] 노드 ID: 안정화됨 (`p:` prefix)
- [x] base: main

---

## 기술적 세부사항

### extractImports() 함수
```javascript
function extractImports(filePath) {
  const imports = [];
  try {
    const content = fs.readFileSync(filePath, 'utf-8');

    // 3가지 regex 패턴
    const importRegex = /import\s+.*?from\s+['"]([^'"]+)['"]/g;
    const dynamicImportRegex = /import\s*\(\s*['"]([^'"]+)['"]\s*\)/g;
    const requireRegex = /require\s*\(\s*['"]([^'"]+)['"]\s*\)/g;

    // 모든 패턴 매칭
    let match;
    while ((match = importRegex.exec(content)) !== null) {
      imports.push(match[1]);
    }
    while ((match = dynamicImportRegex.exec(content)) !== null) {
      imports.push(match[1]);
    }
    while ((match = requireRegex.exec(content)) !== null) {
      imports.push(match[1]);
    }
  } catch {
    // 파일 읽기 실패 시 무시
  }

  return imports;
}
```

### resolveImport() 함수
```javascript
function resolveImport(fromFile, importPath) {
  // 외부 패키지 무시
  if (!importPath.startsWith('.') && !importPath.startsWith('/')) {
    return null;
  }

  // 상대 경로 해결
  const fromDir = path.dirname(path.join(root, fromFile));
  let resolved = path.resolve(fromDir, importPath);

  // 루트 밖으로 나가면 무시
  if (!resolved.startsWith(root)) {
    return null;
  }

  // 상대 경로로 변환
  resolved = path.relative(root, resolved).replaceAll(path.sep, '/');

  // 확장자 추가 시도
  const extensions = ['', '.ts', '.tsx', '.js', '.jsx', '.mjs',
                     '/index.ts', '/index.tsx', '/index.js', '/index.jsx'];

  for (const ext of extensions) {
    const candidate = resolved + ext;
    const fullPath = path.join(root, candidate);
    try {
      if (fs.existsSync(fullPath) && fs.statSync(fullPath).isFile()) {
        return candidate;
      }
    } catch {
      continue;
    }
  }

  return null;
}
```

---

## 다음 단계

### STEP05.3 (예상)
- 엣지 품질 개선 (더 많은 의존성 추적)
- 클러스터 분석 (연관된 파일 그룹화)
- 사이클 감지 (순환 의존성 경고)

---

**작업 완료 시각**: 2025-12-23 00:30
**최종 상태**: PR #13 업데이트 완료, 3개 엣지 정상 생성
