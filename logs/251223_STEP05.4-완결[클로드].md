# STEP05.4 완결 작업 로그

**날짜**: 2025-12-23
**작업자**: 클로드 (Claude Code)
**작업 범위**: STEP05.4 web upload + graph route

---

## 작업 요약

### 완료된 PR

| PR | 제목 | 파일 수 | 상태 | URL |
|---|------|--------|------|-----|
| #15 | STEP05.4 — web upload + graph route | 4 | OPEN | https://github.com/ajong3287/elicon-neural-map/pull/15 |

---

## PR #15 (STEP05.4)

### 목적
- 웹에서 graph.json 업로드 → 서버 저장 → 즉시 시각화
- 로컬 스캔 → 웹 업로드 → 피드백 루프 단축
- 토큰 1개로 최소 보안 (혼자 쓰는 용도)

### 변경 파일
```
1. src/app/api/graph/route.ts (생성)     - POST/GET graph upload API
2. src/app/graph.json/route.ts (생성)    - 서버 저장본 우선 제공, public fallback
3. .env.local.example (생성)            - GRAPH_UPLOAD_TOKEN 템플릿
4. src/app/map/MapClient.tsx (수정)     - 업로드 UI (token + file + 결과 메시지)
```

### 커밋
```
e389ad74 feat: step05.4 web upload graph.json + server route (NEURALMAP-STEP05.4-v0.1)
```

---

## 주요 변경사항

### 1. /api/graph 업로드 API (route.ts)

**위치**: src/app/api/graph/route.ts

**기능**:
- **GET**: .data/graph.json 읽어서 제공 (404 if not exists)
- **POST**: FormData로 파일 업로드, Bearer 토큰 인증, .data/에 저장

**인증**:
```typescript
const token = getToken(); // process.env.GRAPH_UPLOAD_TOKEN
const auth = req.headers.get("authorization") || "";
const got = auth.startsWith("Bearer ") ? auth.slice(7) : "";
if (!token || got !== token) {
  return NextResponse.json({ ok: false, error: "UNAUTHORIZED" }, { status: 401 });
}
```

**파일 저장**:
```typescript
const buf = Buffer.from(await file.arrayBuffer());
fs.mkdirSync(dataDir(), { recursive: true });
fs.writeFileSync(graphPath(), buf);
return NextResponse.json({ ok: true, bytes: buf.length }, { status: 200 });
```

### 2. /graph.json 라우팅 (route.ts)

**위치**: src/app/graph.json/route.ts

**우선순위**:
1. .data/graph.json (서버 저장본) - 최우선
2. public/graph.json (fallback) - 서버 저장본 없을 때
3. 404 - 둘 다 없을 때

**코드**:
```typescript
const p = fs.existsSync(serverGraphPath()) ? serverGraphPath() : publicGraphPath();
if (!fs.existsSync(p)) {
  return NextResponse.json({ ok: false, error: "NO_GRAPH" }, { status: 404 });
}
const txt = fs.readFileSync(p, "utf-8");
return new NextResponse(txt, {
  status: 200,
  headers: { "content-type": "application/json; charset=utf-8", "cache-control": "no-store" },
});
```

### 3. 업로드 UI (MapClient.tsx)

**위치**: src/app/map/MapClient.tsx

**추가된 상태**:
```typescript
const [uploadToken, setUploadToken] = useState("");
const [uploadMsg, setUploadMsg] = useState<string | null>(null);
```

**업로드 핸들러** (line 335-356):
```typescript
async function onUpload(file: File) {
  setUploadMsg(null);
  try {
    if (!uploadToken) {
      setUploadMsg("ERROR: token required");
      return;
    }
    const fd = new FormData();
    fd.append("file", file);
    const r = await fetch("/api/graph", {
      method: "POST",
      headers: { authorization: `Bearer ${uploadToken}` },
      body: fd,
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j?.error ?? `upload failed: ${r.status}`);
    setUploadMsg(`UPLOAD_OK bytes=${j?.bytes ?? 0}`);
    window.location.reload();
  } catch (e: any) {
    setUploadMsg(`ERROR: ${e?.message ?? String(e)}`);
  }
}
```

**UI 렌더** (line 525-546):
- token 입력 (type=password, width=100px)
- file input (accept=application/json)
- 업로드 결과 메시지 (ERROR: 빨강, UPLOAD_OK: 초록)

### 4. 환경변수 템플릿 (.env.local.example)

**내용**:
```
# Copy to .env.local (DO NOT COMMIT .env.local)
GRAPH_UPLOAD_TOKEN=change-me-please
```

**사용법**:
1. `.env.local` 생성 (커밋 금지, .gitignore 등록됨)
2. GRAPH_UPLOAD_TOKEN에 원하는 토큰 설정
3. 웹 UI에서 동일한 토큰 입력 후 업로드

---

## 검증 완료 사항

- [x] pnpm build: Exit 0
- [x] 파일 수: 4개 (route.ts × 2 + .env.local.example + MapClient.tsx)
- [x] base: main
- [x] 외부 패키지 추가 없음 (Next.js 표준만 사용)

---

## 기술적 세부사항

### 웹 기반 컨트롤 루프

**Before (STEP05.3)**:
1. 로컬 스캔 → public/graph.json 생성
2. /map 접속 → public/graph.json 로드
3. 수정 시 다시 스캔 → public/graph.json 교체

**문제**: 파일 시스템 직접 접근, 웹 컨트롤 불가

**After (STEP05.4)**:
1. 로컬 스캔 → graph.json 생성
2. 웹 UI에서 업로드 → .data/graph.json 저장
3. /graph.json이 자동으로 .data/ 우선 제공
4. /map이 즉시 새 graph.json 로드

**장점**:
- 파일 시스템 접근 불필요
- 웹 브라우저만으로 피드백 루프 완성
- 원격 서버에서도 동작 가능 (토큰 인증)

### 보안 고려사항

**현재 구현** (MVP):
- Bearer 토큰 1개 (환경변수)
- 브라우저에서 token 입력 (세션 저장, localStorage 없음)
- HTTPS 없음 (로컬 개발용)

**프로덕션 시 개선 필요**:
- HTTPS 필수 (토큰 암호화)
- 토큰 만료 시간 (1시간 등)
- Rate limiting (업로드 횟수 제한)
- 파일 크기 제한 (현재 무제한)
- CORS 설정 (현재 전체 허용)

---

## 다음 단계

### STEP05.5 (예상)
- 폴더/확장자/허브/고립노드 분포 패널
- 통계 대시보드
- 빈틈 찾기 자동화

---

**작업 완료 시각**: 2025-12-23 02:00
**최종 상태**: PR #15 생성 완료, dev 테스트 대기

