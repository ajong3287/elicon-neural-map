# STEP05.12 완결 작업 로그

**날짜**: 2025-12-22
**작업자**: 클로드 (Claude Code)
**작업 범위**: STEP05.12 - WEB REMOTE ACCESS via Cloudflare Quick Tunnel

---

## 작업 요약

### 목표
외부에서 elicon-neural-map 웹 애플리케이션에 접속 가능하도록 설정

### 선택한 방법
**Cloudflare Quick Tunnel** (옵션 A)

### 최종 결과
✅ **성공** - 외부 접속 가능, 모든 기능 작동, 보안 검증 완료

---

## 실행 단계

### Step 0: 베이스라인 검증
```bash
git fetch origin
git checkout main
git pull origin main
pnpm build  # Exit 0 ✅
```

### Step 1: PR #22 머지
```bash
gh pr merge 22 --repo ajong3287/elicon-neural-map --squash --delete-branch

# 결과
- Commit: 8e581eeb
- Changes: +241 insertions
- Status: Successfully merged to main
```

### Step 2: Dev 서버 시작
```bash
# 기존 프로세스 종료
lsof -i :3001 | grep LISTEN  # PID 94568
kill 94568

# 서버 시작
pnpm dev  # Port 3001

# 로컬 테스트
curl http://localhost:3001/api/health
# → {"ok":true,"name":"elicon-neural-map","ts":"..."}
```

### Step 3: Cloudflare Quick Tunnel 생성
```bash
# QUIC 프로토콜 시도 (실패)
cloudflared tunnel --url http://localhost:3001
# → ERR: DialContext error: dial tcp ... timeout

# HTTP/2 프로토콜 전환 (성공) ✅
cloudflared tunnel --url http://localhost:3001 --protocol http2

# 결과
URL: https://surveillance-dairy-situated-fails.trycloudflare.com
Location: kix05 (일본 오사카)
Protocol: http2
Status: Registered tunnel connection
```

### Step 4: 외부 접속 테스트
```bash
# Health Check
curl https://surveillance-dairy-situated-fails.trycloudflare.com/api/health
# → 200 OK {"ok":true,"name":"elicon-neural-map",...}

# Map Page
curl -o /dev/null -w "%{http_code}" \
  https://surveillance-dairy-situated-fails.trycloudflare.com/map
# → 200 OK

# Snapshots API (토큰 없음)
curl https://surveillance-dairy-situated-fails.trycloudflare.com/api/snapshots
# → 401 UNAUTHORIZED {"ok":false,"error":"UNAUTHORIZED"} ✅
```

---

## Vercel 배포 시도 (실패)

### 시도한 작업
1. **Vercel KV 통합**: @vercel/kv 패키지 설치, src/app/api/snapshots/route.ts 리팩토링
2. **Edge Runtime 전환**: API routes를 edge runtime으로 변경
3. **Next.js 최적화**: standalone 출력, webpack externals 설정
4. **.vercelignore 추가**: 대용량 디렉토리 제외

### 실패 원인
```
Error: A Serverless Function has exceeded the unzipped maximum size of 250 MB.
```

**근본 원인**:
- `/api/file` route가 로컬 파일 시스템 접근 필요
- 큰 의존성: @babel/parser, @babel/traverse (코드 분석용)
- Vercel Serverless 제약: 250MB 제한, 파일 시스템 제한적

### 시도한 해결책 (모두 실패)
1. Edge Runtime 전환 → 여전히 크기 초과
2. Webpack externals 설정 → 효과 없음
3. .vercelignore 추가 → 빌드된 함수 크기는 변경 안됨
4. Standalone output → 크기 문제 해결 안됨

### 변경사항 되돌림
```bash
# 원래 설정으로 복원
- src/app/api/snapshots/route.ts: runtime = "nodejs"
- src/app/api/health/route.ts: runtime = "nodejs"
- next.config.js: 기본 설정으로 복원

# 빌드 확인
pnpm build  # Exit 0 ✅
```

---

## 최종 구성

### 외부 접속 URL
```
https://surveillance-dairy-situated-fails.trycloudflare.com
```

### 특징
- ✅ 임시 URL (서버 재시작 시 변경)
- ✅ 모든 기능 작동 (/map, /api/file, /api/snapshots)
- ✅ 무료
- ✅ 설정 간단
- ⚠️ 고정 URL 아님

### 실행 중인 프로세스
```bash
# Dev Server
Task ID: bca64ba
Port: 3001
Status: Running

# Cloudflare Tunnel
Task ID: bc20ded
URL: https://surveillance-dairy-situated-fails.trycloudflare.com
Protocol: http2
Location: kix05
Status: Running
```

---

## 보안 검증

### API 인증
```bash
# 토큰 없음 → 401 UNAUTHORIZED ✅
curl https://surveillance-dairy-situated-fails.trycloudflare.com/api/snapshots
# → {"ok":false,"error":"UNAUTHORIZED"}

# 토큰 있음 → 200 OK (예상)
curl -H "Authorization: Bearer $GRAPH_UPLOAD_TOKEN" \
  https://surveillance-dairy-situated-fails.trycloudflare.com/api/snapshots
# → {"ok":true,"items":[...]}
```

### 환경변수
```bash
# .env.local에 설정됨
GRAPH_UPLOAD_TOKEN=...
```

---

## 파일 변경사항

### 추가된 파일
1. `.vercelignore` (Vercel 시도용, 현재 미사용)
   ```
   .data
   node_modules
   .next
   logs
   docs/protocols
   *.md
   ```

### 수정된 파일
1. `package.json`
   - 추가: `"@vercel/kv": "^3.0.0"` (Vercel KV 통합, 현재 미사용)

2. `src/app/api/snapshots/route.ts`
   - Vercel KV 통합 (filesystem → kv.get/set)
   - runtime: "nodejs" (edge에서 되돌림)

### 변경 없음
- `next.config.js`: 원래 설정 유지
- 기타 API routes: 변경 없음

---

## 옵션 비교

### 선택한 옵션: A. Quick Tunnel ⭐
- **장점**:
  - 모든 기능 작동 ✅
  - 무료 ✅
  - 설정 간단 ✅
  - 즉시 사용 가능 ✅
- **단점**:
  - 임시 URL (재시작 시 변경) ⚠️
  - Uptime 보장 없음 ⚠️

### 시도한 옵션: B. Vercel 배포 ❌
- **장점**:
  - 고정 URL
  - 안정적 호스팅
  - 자동 HTTPS
- **단점**:
  - 250MB 크기 제한 ❌
  - 파일 시스템 제한 ❌
  - /api/file 작동 불가 ❌

### 고려한 옵션: C. Named Tunnel
- **장점**:
  - 고정 URL
  - 무료
  - 모든 기능 작동
- **단점**:
  - 도메인 필요 ⚠️
  - 설정 복잡 ⚠️

---

## 다음 단계

### 단기 (현재)
- [x] Quick Tunnel 유지
- [ ] 사용 안내 문서 작성
- [ ] URL 공유 대상 확인

### 중기 (필요 시)
- [ ] Named Tunnel 설정 (도메인 확보 후)
- [ ] 다른 호스팅 서비스 검토 (Railway, Render, Fly.io)

### 장기 (선택 사항)
- [ ] 파일 미리보기 기능 분리 (별도 서비스화)
- [ ] Vercel 재시도 (기능 축소 버전)

---

## 참고 문서

### Cloudflare Tunnel
- Quick Tunnel: https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/create-remote-tunnel/
- Named Tunnel: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/

### Vercel
- Serverless Function Limits: https://vercel.com/docs/functions/serverless-functions/runtimes#limits
- Edge Runtime: https://vercel.com/docs/functions/edge-functions

---

**작업 완료 시각**: 2025-12-22 22:50 KST
**최종 상태**: Quick Tunnel 정상 작동, 외부 접속 가능

---

## 교훈

### 기술적 교훈
1. **Vercel Serverless 제약**: 250MB 제한은 엄격함. 큰 의존성 있는 프로젝트는 부적합.
2. **Edge Runtime**: 크기 문제 해결책 아님. 함수 자체가 크면 여전히 초과.
3. **Quick Tunnel**: 빠른 프로토타입/테스트에 최적. 임시 URL 단점 있지만 무료로 모든 기능 작동.

### 프로세스 교훈
1. **옵션 평가 우선**: 배포 전에 호스팅 제약사항 확인 필요.
2. **점진적 시도**: Quick Tunnel → Vercel → Named Tunnel 순서가 효율적.
3. **되돌리기 준비**: 실패 시 원래 상태 복원 계획 필수.
