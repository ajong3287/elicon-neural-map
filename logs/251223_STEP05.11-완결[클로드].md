# STEP05.11 완결 작업 로그

**날짜**: 2025-12-23
**작업자**: 클로드 (Claude Code)
**작업 범위**: STEP05.11 server snapshot storage

---

## 작업 요약

### 완료된 PR

| PR | 제목 | 파일 수 | 상태 | URL |
|---|------|--------|------|-----|
| #22 | STEP05.11 — server snapshots | 3 | OPEN | https://github.com/ajong3287/elicon-neural-map/pull/22 |

---

## PR #22 (STEP05.11)

### 목적
- 서버 측 스냅샷 저장소 구현 (브라우저 localStorage를 넘어)
- /api/snapshots 엔드포인트로 영구 저장
- 브라우저/기기 간 스냅샷 공유 가능

### 변경 파일
```
1. .gitignore (생성)                  - .data/ 추가
2. src/app/api/snapshots/route.ts (생성) - GET/POST/DELETE API
3. src/app/map/MapClient.tsx (수정)   - 서버 함수 + UI 버튼
```

### 커밋
```
55ffd41f feat: STEP05.11 server snapshots (NEURALMAP-STEP05.11-v0.1)
```

---

## 주요 변경사항

### 1. .gitignore

**위치**: 프로젝트 루트

**내용**:
```.gitignore
.env.local
.data/
```

**목적**: 서버 저장소 파일(.data/snapshots.json) 커밋 방지

### 2. /api/snapshots 엔드포인트

**위치**: src/app/api/snapshots/route.ts

**기능**:
- **GET**: 저장된 스냅샷 목록 조회 (Bearer 토큰 인증)
- **POST**: 새 스냅샷 저장 (최대 50개, 최신순)
- **DELETE**: 스냅샷 삭제 (id 파라미터)

**인증**:
```typescript
function isAuthed(req: Request) {
  const token = process.env.GRAPH_UPLOAD_TOKEN || "";
  if (!token) return false;
  const h = req.headers.get("authorization") || "";
  // Authorization: Bearer <token>
  if (h.startsWith("Bearer ")) {
    return h.slice("Bearer ".length).trim() === token;
  }
  // fallback: x-graph-token
  const x = req.headers.get("x-graph-token") || "";
  return x === token;
}
```

**저장소 구조**:
```typescript
type SavedSnap = {
  id: string;
  name: string;
  url: string;
  createdAt: string;
};

// 파일 위치: .data/snapshots.json
// 최대 개수: 50개 (최신순)
```

**파일 작업**:
```typescript
function dataFilePath() {
  return path.join(process.cwd(), ".data", "snapshots.json");
}

function ensureStore() {
  const p = dataFilePath();
  const dir = path.dirname(p);
  fs.mkdirSync(dir, { recursive: true });
  if (!fs.existsSync(p)) {
    fs.writeFileSync(p, JSON.stringify([], null, 2), "utf-8");
  }
  return p;
}

function readStore(): SavedSnap[] {
  const p = ensureStore();
  try {
    const raw = fs.readFileSync(p, "utf-8");
    const list = JSON.parse(raw);
    return Array.isArray(list) ? (list as SavedSnap[]) : [];
  } catch {
    return [];
  }
}

function writeStore(list: SavedSnap[]) {
  const p = ensureStore();
  fs.writeFileSync(p, JSON.stringify(list, null, 2), "utf-8");
}
```

### 3. MapClient.tsx 변경사항

**위치**: src/app/map/MapClient.tsx

#### 3.1 상태 추가 (line 249-250)

```typescript
// STEP05.11: Server snapshot state
const [uploadToken, setUploadToken] = useState("");
```

#### 3.2 서버 함수 추가 (line 305-336)

```typescript
// STEP05.11: Server snapshot functions
async function serverList(token: string) {
  const r = await fetch("/api/snapshots", {
    method: "GET",
    headers: { authorization: `Bearer ${token}` },
    cache: "no-store",
  });
  if (!r.ok) throw new Error(`LIST_FAILED_${r.status}`);
  return (await r.json()) as any;
}

async function serverSave(token: string, payload: { id: string; name: string; url: string; createdAt: string }) {
  const r = await fetch("/api/snapshots", {
    method: "POST",
    headers: {
      "content-type": "application/json",
      authorization: `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });
  if (!r.ok) throw new Error(`SAVE_FAILED_${r.status}`);
  return (await r.json()) as any;
}

async function serverDelete(token: string, id: string) {
  const r = await fetch(`/api/snapshots?id=${encodeURIComponent(id)}`, {
    method: "DELETE",
    headers: { authorization: `Bearer ${token}` },
  });
  if (!r.ok) throw new Error(`DEL_FAILED_${r.status}`);
  return (await r.json()) as any;
}
```

#### 3.3 UI 버튼 추가 (line 1403-1489)

**토큰 입력 + 2개 버튼**:
- 토큰 입력: type=password, width=100px, placeholder="토큰"
- "서버로 저장" 버튼: 현재 첫 번째 스냅샷을 서버에 저장
- "서버에서 불러오기" 버튼: 서버에서 스냅샷 목록 불러와서 로컬 상태 덮어쓰기

**에러 처리**:
- 토큰 없음 → "ERROR: 토큰 필요"
- 저장할 스냅샷 없음 → "ERROR: 저장할 스냅샷 없음"
- 서버 에러 → "ERROR: {e.message}"

**성공 메시지**:
- 저장 성공 → "SERVER_SAVED: {count}개"
- 불러오기 성공 → "SERVER_LOADED: {count}개"

---

## 검증 완료 사항

- [x] pnpm build: Exit 0
- [x] 파일 수: 3개 (.gitignore + route.ts + MapClient.tsx)
- [x] base: main (PR #20, #21 먼저 머지됨)
- [x] 외부 패키지 추가 없음 (Node.js fs 모듈만 사용)
- [x] GRAPH_UPLOAD_TOKEN 재사용 (새 env 추가 없음)

---

## 기술적 세부사항

### 서버 스냅샷 워크플로우

**Before (STEP05.10)**:
1. 스냅샷 저장 → localStorage only
2. 브라우저 닫으면 → 유지
3. 다른 기기/브라우저 → 접근 불가

**After (STEP05.11)**:
1. 스냅샷 저장 → localStorage (로컬)
2. "서버로 저장" → .data/snapshots.json (영구)
3. 다른 기기/브라우저 → "서버에서 불러오기" → 동기화

**장점**:
- 브라우저/기기 간 스냅샷 공유
- 영구 저장 (localStorage 용량 제한 없음)
- 토큰 기반 보안 (GRAPH_UPLOAD_TOKEN 재사용)

### 보안 고려사항

**현재 구현** (MVP):
- Bearer 토큰 1개 (환경변수)
- 브라우저에서 token 입력 (type=password, 세션 저장 없음)
- HTTPS 없음 (로컬 개발용)

**프로덕션 시 개선 필요**:
- HTTPS 필수 (토큰 암호화)
- 토큰 만료 시간 (1시간 등)
- Rate limiting (업로드 횟수 제한)
- 파일 크기 제한 (현재 무제한)
- CORS 설정 (현재 전체 허용)

### 저장소 구조

**파일 위치**: `.data/snapshots.json`

**예시 내용**:
```json
[
  {
    "id": "snap_1703345678901_a1b2c3",
    "name": "초기 구조 탐색",
    "url": "/map?dir=src%2Fapp&ext=tsx&hid=1&hub=6&fid=src%2Fapp%2Fmap%2FMapClient.tsx&fonly=0&vp=1704.5%2C869%2C0.5",
    "createdAt": "2025-12-23T10:21:18.901Z"
  },
  {
    "id": "snap_1703345789012_d4e5f6",
    "name": "API 엔드포인트 집중",
    "url": "/map?dir=src%2Fapp%2Fapi&ext=ts&hid=0&hub=3&fid=src%2Fapp%2Fapi%2Fsnapshots%2Froute.ts&fonly=1&vp=1200%2C800%2C0.8",
    "createdAt": "2025-12-23T10:23:09.012Z"
  }
]
```

**제한**:
- 최대 50개 (line 88: `const next = [item, ...list].slice(0, 50);`)
- 최신순 정렬 (새로운 항목이 배열 앞에 추가)

---

## 다음 단계

### STEP05.12 (예상)
- 폴더/확장자/허브/고립노드 분포 패널
- 통계 대시보드
- 빈틈 찾기 자동화

또는

### 통합 테스트
- 전체 STEP05 시리즈 (v5.8 ~ v5.11) 통합 동작 확인
- 프로덕션 배포 준비

---

**작업 완료 시각**: 2025-12-23 03:15
**최종 상태**: PR #22 생성 완료, 머지 대기

---

## 의존성 체인

```
STEP05.8 (URL 스냅샷)
  ↓
STEP05.9 (Health API + 배포 문서)
  ↓
STEP05.10 (Snapshot History - localStorage)
  ↓
STEP05.11 (Server Snapshots - .data/snapshots.json) ← 현재
```

**전제 조건**:
- PR #20 (STEP05.9) ✅ 머지됨
- PR #21 (STEP05.10) ✅ 머지됨

**다음 단계**:
- PR #22 (STEP05.11) 리뷰 → 머지
- STEP05.12 계획 수립 (통계 대시보드)
