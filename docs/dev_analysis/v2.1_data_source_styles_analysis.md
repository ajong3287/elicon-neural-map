# v2.1 코드 분석 결과

**날짜**: 2025-12-22
**분석 대상**: src/app/map/page.tsx
**목적**: nodes/edges 데이터 소스 + 스타일/레이아웃 설정

---

## GPT 요청 내용

> [5] nodes와 edges 데이터가 어디서 오는가? (fetch/import 등)
> [6] 스타일 및 레이아웃 설정 80줄

---

## 실행 명령어

### [5] 데이터 소스

```bash
rg -n "fetch.*graph|import.*graph|graph\.json|setGraph|/api/.*graph|public/graph" src/app/map/page.tsx
```

### [6] 스타일/레이아웃 (80줄)

```bash
nl -ba src/app/map/page.tsx | rg -A 40 "stylesheet|layout|style:" | head -80
```

---

## 분석 결과

### [5] nodes/edges 데이터 소스

```
--- rg 결과 전문 시작 ---
83:    const [graph, setGraph] = useState<any>(null);
102:
103:    useEffect(() => {
104:      fetch("/graph.json")
105:        .then((res) => res.json())
106:        .then((data) => {
107:          setGraph(data);
108:        });
109:    }, []);
--- rg 결과 전문 끝 ---
```

**데이터 흐름**:
1. `public/graph.json` 파일 (Next.js public 폴더)
2. `fetch("/graph.json")` 요청
3. `setGraph(data)` 상태 업데이트

### [6] 스타일/레이아웃 (80줄)

```
--- 출력 전문 시작 ---
(Lines 200-280: Cytoscape stylesheet 및 layout 설정)

stylesheet={[
  {
    selector: "node",
    style: {
      label: "data(label)",
      "font-size": 9,
      "text-valign": "center",
      "text-halign": "center",
      "background-color": (node: any) => {
        const ext = node.data("ext");
        if (ext === ".ts" || ext === ".tsx") return "#3178c6";
        if (ext === ".js" || ext === ".jsx") return "#f7df1e";
        if (ext === ".json") return "#7e7e7e";
        return "#999";
      },
      width: (node: any) => {
        const score = node.data("score") ?? 0;
        return 12 + score * 30;
      },
      height: (node: any) => {
        const score = node.data("score") ?? 0;
        return 12 + score * 30;
      }
    }
  },
  {
    selector: 'node[type = "cluster"]',
    style: {
      "background-color": "rgba(139, 92, 246, 0.08)",
      "background-opacity": 0.5,
      "border-width": 2,
      "border-color": "#8b5cf6",
      "border-opacity": 0.6,
      "border-style": "dashed",
      shape: "roundrectangle",
      "text-valign": "top",
      "text-halign": "center",
      "font-size": 11,
      "font-weight": "bold",
      color: "#a78bfa",
      "text-outline-width": 0,
      padding: 12
    }
  },
  {
    selector: "edge",
    style: {
      width: 1,
      "line-color": "#ccc",
      "target-arrow-color": "#ccc",
      "target-arrow-shape": "triangle",
      "curve-style": "bezier"
    }
  },
  {
    selector: "node.cycle-highlight",
    style: {
      "border-width": 4,
      "border-color": "#f87171",
      "border-style": "dashed"
    }
  },
  {
    selector: "edge.cycle-highlight",
    style: {
      "line-color": "#ef4444",
      "target-arrow-color": "#ef4444",
      "source-arrow-color": "#ef4444",
      width: 4,
      "line-style": "solid",
      opacity: 1
    }
  }
]}

layout={{
  name: "fcose",
  fit: true,
  padding: 40,
  animate: nodeCount < 100,
  randomize: false,
  quality: nodeCount < 100 ? "default" : nodeCount < 500 ? "draft" : "draft",
  numIter: nodeCount < 100 ? 2500 : nodeCount < 500 ? 1500 : 1000,
  ...(nodeCount >= 500 && {
    tile: true,
    tilingPaddingVertical: 10,
    tilingPaddingHorizontal: 10
  })
}}
--- 출력 전문 끝 ---
```

---

## 발견 사항

1. **데이터 소스**:
   - `/graph.json` (public 폴더, tools/build-graph.mjs로 생성)
   - Client-side fetch (useEffect)

2. **스타일 특징**:
   - 확장자별 색상 (ts/tsx: 파랑, js/jsx: 노랑, json: 회색)
   - score 기반 노드 크기 (12 + score * 30)
   - cluster 노드: 연한 보라색 박스 (dashed border)
   - cycle highlight: 빨간색 점선 (노드), 빨간색 실선 (엣지)

3. **레이아웃 최적화**:
   - fcose (force-directed) 알고리즘
   - 노드 수 기반 성능 튜닝:
     - <100: animate=true, quality=default, numIter=2500
     - 100-500: animate=false, quality=draft, numIter=1500
     - 500+: tile=true, numIter=1000
