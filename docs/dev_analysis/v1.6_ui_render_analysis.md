# v1.6 코드 분석 결과

**날짜**: 2025-12-22
**분석 대상**: src/app/map/page.tsx
**목적**: UI 렌더링 방식 파악 (Cytoscape vs ReactFlow)

---

## GPT 요청 내용

> "src/app/map/page.tsx가 어떤 UI 렌더 방식을 쓰는지 파악하고, nodes와 edges 관련 로직 80줄 정도 뽑아줘"

---

## 실행 명령어

```bash
# UI 렌더링 방식 확인
rg -n "CytoscapeComponent|ReactFlow|<Cytoscape|import.*cytoscape" src/app/map/page.tsx

# nodes/edges 관련 로직 80줄
nl -ba src/app/map/page.tsx | rg -A 40 "const nodes|const edges" | head -80
```

---

## 분석 결과

### [1] UI 렌더링 방식

```
1:import CytoscapeComponent from "react-cytoscapejs";
2:import Cytoscape from "cytoscape";
3:import fcose from "cytoscape-fcose";
```

**결론**: Cytoscape.js 사용 (ReactFlow 아님)

### [2] nodes/edges 로직 (80줄)

```typescript
// Lines 144-224 (80 lines)
const nodeToCluster = new Map<string, string>();
graph.clusters?.forEach((cluster) => {
  if (!collapsedClusters.has(cluster.id)) {
    cluster.nodeIds.forEach((nodeId) => {
      nodeToCluster.set(nodeId, cluster.id);
    });
  }
});

const nodes = graph.nodes
  .filter((n) => {
    if (collapsedClusters.has(nodeToCluster.get(n.id) || "")) {
      return false;
    }
    if (search && !n.label.toLowerCase().includes(search.toLowerCase())) {
      return false;
    }
    if (selectedFolder !== "all" && !n.path.startsWith(selectedFolder)) {
      return false;
    }
    const score = n.score ?? 0;
    if (score < scoreRange.min || score > scoreRange.max) {
      return false;
    }
    return true;
  })
  .map((n) => ({
    data: {
      id: n.id,
      label: n.label,
      ext: n.ext,
      degree: n.degree ?? 0,
      score: n.score ?? 0,
      path: n.path,
      parent: nodeToCluster.get(n.id)
    },
  }));

const nodeIdSet = new Set(nodes.map((n) => n.data.id));

const edges = graph.edges
  .filter((e) => {
    if (!nodeIdSet.has(e.source) || !nodeIdSet.has(e.target)) {
      return false;
    }
    return true;
  })
  .map((e) => ({
    data: {
      id: `${e.source}-${e.target}`,
      source: e.source,
      target: e.target,
    },
  }));

const clusterNodes: any[] = [];
graph.clusters?.forEach((cluster) => {
  if (!collapsedClusters.has(cluster.id)) {
    const hasVisibleNodes = cluster.nodeIds.some((nodeId) => nodeIdSet.has(nodeId));
    if (hasVisibleNodes) {
      clusterNodes.push({
        data: {
          id: cluster.id,
          label: cluster.label,
          type: 'cluster'
        }
      });
    }
  }
});

return [...clusterNodes, ...nodes, ...edges];
```

---

## 발견 사항

1. **Cytoscape.js 사용**: react-cytoscapejs 래퍼 사용
2. **Compound Nodes**: parent 속성으로 cluster 그룹화
3. **필터링 체인**: search → folder → score range → collapsed clusters
4. **성능 최적화**: nodeIdSet으로 O(1) 조회
5. **동적 cluster nodes**: 보이는 노드가 있을 때만 cluster parent 생성
